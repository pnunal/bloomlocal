<?php
namespace Bloomlocal\Dev;

final class Hotlink {
    private $script;

    private function __construct($script) {
        $this->script = $script;
    }

    private function evaluate() {
        $allowed = false;
        switch (dirname($this->script)) {
            case '/':
                $allowed = $this->isAllowedOnRoot();
            break;
            case '/wp-admin':
                $allowed = $this->isAllowedOnAdmin();
            break;
        }

        return $allowed;
    }

    private function isAllowedOnRoot() {
        switch (basename($this->script)) {
            case 'index.php':
            case 'wp-activate.php':
            case 'wp-comments-post.php':
            case 'wp-cron.php':
            case 'wp-links-opml.php':
            case 'wp-login.php':
            case 'wp-mail.php':
            case 'wp-signup.php':
            case 'wp-trackback.php':
            case 'xmlrpc.php':
                return true;

        }
        return false;
    }

    private function isAllowedOnAdmin() {
        switch (basename($this->script)) {
            case 'about.php':
            case 'admin-ajax.php':
            case 'admin.php':
            case 'admin-post.php':
            case 'async-upload.php':
            case 'comment.php':
            case 'credits.php':
            case 'customize.php':
            case 'edit-comments.php':
            case 'edit.php':
            case 'edit-tags.php':
            case 'erase-personal-data.php':
            case 'export-personal-data.php':
            case 'export.php':
            case 'freedoms.php':
            case 'import.php':
            case 'index.php':
            case 'install-helper.php':
            case 'install.php':
            case 'link-add.php':
            case 'link-manager.php':
            case 'link.php':
            case 'load-scripts.php':
            case 'load-styles.php':
            case 'media-new.php':
            case 'media.php':
            case 'media-upload.php':
            case 'menu.php':
            case 'moderation.php':
            // case 'ms-admin.php':
            // case 'ms-delete-site.php':
            // case 'ms-edit.php':
            // case 'ms-options.php':
            // case 'ms-sites.php':
            // case 'ms-themes.php':
            // case 'ms-upgrade-network.php':
            // case 'ms-users.php':
            // case 'my-sites.php':
            case 'nav-menus.php':
            // case 'network.php':
            case 'options-discussion.php':
            case 'options-general.php':
            case 'options-media.php':
            case 'options-permalink.php':
            case 'options.php':
            case 'options-privacy.php':
            case 'options-reading.php':
            case 'options-writing.php':
            case 'plugin-editor.php':
            case 'plugin-install.php':
            case 'plugins.php':
            case 'post-new.php':
            case 'post.php':
            case 'press-this.php':
            case 'privacy.php':
            case 'privacy-policy-guide.php':
            case 'profile.php':
            case 'revision.php':
            // case 'setup-config.php':
            case 'site-health-info.php':
            case 'site-health.php':
            case 'term.php':
            case 'theme-editor.php':
            case 'theme-install.php':
            case 'themes.php':
            case 'tools.php':
            case 'update-core.php':
            case 'update.php':
            // case 'upgrade-functions.php':
            case 'upgrade.php':
            case 'upload.php':
            case 'user-edit.php':
            case 'user-new.php':
            case 'users.php':
            case 'widgets.php':
                return true;
        }
        return false;
    }

    static function allowed($vars = array()) {
        $checker = new static($vars);
        $allowed = $checker->evaluate();
        unset($checker);
        return $allowed;
    }
}

if (!Hotlink::allowed($_SERVER['SCRIPT_NAME'])) {
    $message = sprintf('[%s] Deny %s', date('Y-m-d H:i:s T'), $_SERVER['SCRIPT_NAME']);
    file_put_contents(__DIR__.'/deny.log', $message.PHP_EOL, FILE_APPEND);
    
    @mail('dev@bloomlocal.com', $message, print_r($_SERVER, 1));
    
    header('HTTP/1.0 404 Not Found');
    exit;
}
